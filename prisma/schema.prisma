generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Note: Using String fields instead of enums for SQLite compatibility
// Role: ADMIN | CONTRACTOR | FELLOW
// TimeEntryStatus: DRAFT | SUBMITTED | LOCKED
// InvoiceStatus: DRAFT | SUBMITTED | APPROVED | REJECTED | PAID
// ClientInvoiceStatus: DRAFT | EXPORTED

model User {
  id                String   @id @default(cuid())
  name              String
  email             String   @unique
  passwordHash      String
  role              String   @default("CONTRACTOR") // ADMIN, CONTRACTOR, FELLOW
  defaultHourlyRate Decimal? @default(0)
  active            Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  timeEntries      TimeEntry[]
  invoices         Invoice[]
  userCategories   UserCategory[]
  approvedInvoices Invoice[] @relation("ApprovedBy")
  clientRequests   ClientRequest[]
}

model Client {
  id        String   @id @default(cuid())
  name      String
  isSystem  Boolean  @default(false)
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  projects            Project[]
  timeEntries         TimeEntry[]
  invoiceLineItems    InvoiceLineItem[]
  clientInvoiceDrafts ClientInvoiceDraft[]
}

model ClientRequest {
  id          String   @id @default(cuid())
  name        String
  note        String?
  requestedBy String
  status      String   @default("PENDING") // PENDING, APPROVED, REJECTED
  createdAt   DateTime @default(now())

  user User @relation(fields: [requestedBy], references: [id])
}

model Project {
  id        String   @id @default(cuid())
  name      String
  clientId  String
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  client           Client            @relation(fields: [clientId], references: [id])
  timeEntries      TimeEntry[]
  invoiceLineItems InvoiceLineItem[]
}

model Category {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userCategories   UserCategory[]
  timeEntries      TimeEntry[]
  invoiceLineItems InvoiceLineItem[]
}

model UserCategory {
  id         String  @id @default(cuid())
  userId     String
  categoryId String
  sortOrder  Int     @default(0)
  active     Boolean @default(true)

  user     User     @relation(fields: [userId], references: [id])
  category Category @relation(fields: [categoryId], references: [id])

  @@unique([userId, categoryId])
}

model TimeEntry {
  id              String   @id @default(cuid())
  userId          String
  date            DateTime
  clientId        String
  projectId       String?
  categoryId      String
  hours           Decimal
  whatDidYouDo    String
  whatGotCompleted String?
  status          String   @default("DRAFT") // DRAFT, SUBMITTED, LOCKED
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user     User      @relation(fields: [userId], references: [id])
  client   Client    @relation(fields: [clientId], references: [id])
  project  Project?  @relation(fields: [projectId], references: [id])
  category Category  @relation(fields: [categoryId], references: [id])
  invoiceId String?
  invoice   Invoice?  @relation(fields: [invoiceId], references: [id])
}

model Invoice {
  id            String   @id @default(cuid())
  userId        String
  periodStart   DateTime
  periodEnd     DateTime
  invoiceNumber String   @unique
  status        String   @default("DRAFT") // DRAFT, SUBMITTED, APPROVED, REJECTED, PAID
  totalHours    Decimal  @default(0)
  totalAmount   Decimal  @default(0)
  notes         String?
  rejectionReason String?
  pdfPath       String?
  submittedAt   DateTime?
  approvedAt    DateTime?
  approvedById  String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user       User              @relation(fields: [userId], references: [id])
  approvedBy User?             @relation("ApprovedBy", fields: [approvedById], references: [id])
  lineItems  InvoiceLineItem[]
  timeEntries TimeEntry[]
  clientInvoiceDrafts ClientInvoiceDraftInvoice[]
}

model InvoiceLineItem {
  id          String  @id @default(cuid())
  invoiceId   String
  clientId    String
  projectId   String?
  categoryId  String
  description String
  hours       Decimal
  rate        Decimal
  amount      Decimal

  invoice  Invoice   @relation(fields: [invoiceId], references: [id])
  client   Client    @relation(fields: [clientId], references: [id])
  project  Project?  @relation(fields: [projectId], references: [id])
  category Category  @relation(fields: [categoryId], references: [id])
}

model ClientInvoiceDraft {
  id          String   @id @default(cuid())
  clientId    String
  periodStart DateTime
  periodEnd   DateTime
  status      String   @default("DRAFT") // DRAFT, EXPORTED
  totalAmount Decimal  @default(0)
  csvPath     String?
  pdfPath     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  client   Client @relation(fields: [clientId], references: [id])
  invoices ClientInvoiceDraftInvoice[]
}

model ClientInvoiceDraftInvoice {
  id                   String @id @default(cuid())
  clientInvoiceDraftId String
  invoiceId            String

  clientInvoiceDraft ClientInvoiceDraft @relation(fields: [clientInvoiceDraftId], references: [id])
  invoice            Invoice            @relation(fields: [invoiceId], references: [id])

  @@unique([clientInvoiceDraftId, invoiceId])
}
